{# ABOUTME: Chat transcript partial with avatar initials and message continuations. #}
{# ABOUTME: SSE-refreshed via parent compositor; shows grouped messages and question cards. #}

<div id="{{ container_id }}"
     class="chat-transcript-wrap"
     hx-trigger="sse:transcript_appended, sse:question_asked, sse:question_answered, sse:agent_step_started, sse:agent_step_finished"
     hx-get="/web/specs/{{ spec_id }}/activity/transcript?container_id={{ container_id }}"
     hx-target="#{{ container_id }}"
     hx-swap="outerHTML">
    <div class="chat-messages" id="{{ container_id }}-feed">
        {% for entry in transcript %}
        {% if entry.is_step %}
        <div class="chat-status-line">
            <span class="status-dot dot-{{ entry.role_class }}"></span>
            <span class="chat-status-body">{{ entry.sender_label }} {{ entry.content }}</span>
            <span class="chat-status-time">{{ entry.timestamp }}</span>
        </div>
        {% else %}
        <div class="chat-message {% if entry.is_continuation %}chat-continuation{% endif %}">
            {% if !entry.is_continuation %}
            <div class="chat-message-header">
                <div class="chat-avatar avatar-{{ entry.role_class }}">{{ entry.sender_label|truncate(1) }}</div>
                <span class="chat-sender">{{ entry.sender_label }}</span>
                <span class="chat-time">{{ entry.timestamp }}</span>
            </div>
            {% endif %}
            <div class="chat-body">{{ entry.content }}</div>
        </div>
        {% endif %}
        {% endfor %}
        {% if transcript.is_empty() %}
        <div class="chat-empty">
            <div class="chat-empty-icon">&#128172;</div>
            <p class="chat-empty-title">No messages yet</p>
            <p class="chat-empty-hint">Type below to start a conversation with the agents.</p>
        </div>
        {% endif %}
    </div>

    {% match pending_question %}
    {% when Some with (q) %}
    <div class="chat-question-card">
        <div class="chat-message-header">
            <div class="chat-avatar avatar-question">?</div>
            <span class="chat-sender">Quick decision</span>
        </div>
        {% match q %}
        {% when QuestionData::Boolean { question_id, question, default } %}
        <div class="chat-question-body">{{ question }}</div>
        <form hx-post="/web/specs/{{ spec_id }}/answer"
              hx-target="#{{ container_id }}"
              hx-swap="outerHTML"
              class="chat-question-options">
            <input type="hidden" name="question_id" value="{{ question_id }}">
            <button type="submit" name="answer" value="Yes" class="chat-option-btn">Yes</button>
            <button type="submit" name="answer" value="No" class="chat-option-btn">No</button>
        </form>

        {% when QuestionData::MultipleChoice { question_id, question, choices, allow_multi } %}
        <div class="chat-question-body">{{ question }}</div>
        <form hx-post="/web/specs/{{ spec_id }}/answer"
              hx-target="#{{ container_id }}"
              hx-swap="outerHTML"
              class="chat-question-options">
            <input type="hidden" name="question_id" value="{{ question_id }}">
            {% for choice in choices %}
            <button type="submit" name="answer" value="{{ choice }}" class="chat-option-btn">{{ choice }}</button>
            {% endfor %}
        </form>

        {% when QuestionData::Freeform { question_id, question, placeholder } %}
        <div class="chat-question-body">{{ question }}</div>
        <form hx-post="/web/specs/{{ spec_id }}/answer"
              hx-target="#{{ container_id }}"
              hx-swap="outerHTML"
              class="chat-question-options">
            <input type="hidden" name="question_id" value="{{ question_id }}">
            <textarea name="answer" placeholder="{{ placeholder }}" rows="2" class="chat-question-textarea"></textarea>
            <button type="submit" class="chat-option-btn">Submit</button>
        </form>
        {% endmatch %}
    </div>
    {% when None %}
    {% endmatch %}
</div>

<script>
    (function() {
        var feed = document.getElementById('{{ container_id }}-feed');
        if (!feed) return;
        var nearBottom = (feed.scrollHeight - feed.scrollTop - feed.clientHeight) < 80;
        if (nearBottom) feed.scrollTop = feed.scrollHeight;
    })();
</script>
