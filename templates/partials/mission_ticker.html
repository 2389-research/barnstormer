{# ABOUTME: Compact activity ticker for the mission strip. #}
{# ABOUTME: Shows last 10 transcript entries and pending question widget in a compact format. #}

<div class="mission-ticker" id="mission-ticker-feed">
    {% for entry in ticker_entries %}
    <div class="ticker-entry">
        <span class="status-dot dot-{{ entry.role_class }}"></span>
        <span class="ticker-sender">{{ entry.sender_label }}</span>
        <span class="ticker-text">{{ entry.content }}</span>
        <span class="ticker-time">{{ entry.timestamp }}</span>
    </div>
    {% endfor %}
    {% if ticker_entries.is_empty() %}
    <div class="ticker-empty">Awaiting activity...</div>
    {% endif %}
</div>

{% match pending_question %}
{% when Some with (q) %}
<div class="question-widget" id="question-widget">
    {% match q %}
    {% when QuestionData::Boolean { question_id, question, default } %}
    <div class="question-header">Agent is asking:</div>
    <p class="question-text">{{ question }}</p>
    <form hx-post="/web/specs/{{ spec_id }}/answer"
          hx-target="#mission-ticker"
          hx-swap="innerHTML">
        <input type="hidden" name="question_id" value="{{ question_id }}">
        <div class="bool-buttons">
            <button type="submit" name="answer" value="Yes" class="btn btn-answer btn-yes">Yes</button>
            <button type="submit" name="answer" value="No" class="btn btn-answer btn-no">No</button>
        </div>
    </form>

    {% when QuestionData::MultipleChoice { question_id, question, choices, allow_multi } %}
    <div class="question-header">Agent is asking:</div>
    <p class="question-text">{{ question }}</p>
    <form hx-post="/web/specs/{{ spec_id }}/answer"
          hx-target="#mission-ticker"
          hx-swap="innerHTML">
        <input type="hidden" name="question_id" value="{{ question_id }}">
        <div class="question-choices">
            {% for choice in choices %}
            <label class="choice-label">
                {% if allow_multi %}
                <input type="checkbox" name="answer" value="{{ choice }}">
                {% else %}
                <input type="radio" name="answer" value="{{ choice }}">
                {% endif %}
                <span class="choice-text">{{ choice }}</span>
            </label>
            {% endfor %}
        </div>
        <button type="submit" class="btn btn-answer btn-submit">Submit</button>
    </form>

    {% when QuestionData::Freeform { question_id, question, placeholder } %}
    <div class="question-header">Agent is asking:</div>
    <p class="question-text">{{ question }}</p>
    <form hx-post="/web/specs/{{ spec_id }}/answer"
          hx-target="#mission-ticker"
          hx-swap="innerHTML">
        <input type="hidden" name="question_id" value="{{ question_id }}">
        <div class="form-group">
            <textarea name="answer" placeholder="{{ placeholder }}" rows="2"></textarea>
        </div>
        <button type="submit" class="btn btn-answer btn-submit">Submit</button>
    </form>
    {% endmatch %}
</div>
{% when None %}
{% endmatch %}

<script>
    (function() {
        var feed = document.getElementById('mission-ticker-feed');
        if (!feed) return;
        feed.scrollTop = feed.scrollHeight;
    })();
</script>
